= git pre-commit
Nick Hardiman <nhardima@redhat.com>
:source-highlighter: highlight.js
:toc:
:revdate: 07-12-2023

https://pre-commit.com/
pre-commit
A framework for managing and maintaining multi-language pre-commit hooks.

https://aap2.demoredhat.com/decks/config_as_code.pdf


== install 

https://aap2.demoredhat.com/exercises/ansible_config_as_code/0-setup/
step 1

[source,shell]
----
source ~/lab-build-proxy.sh 
source venv-ansible-2.15/bin/activate
pip3 install --upgrade pip
pip3 install pre-commit
----


[source,shell]
----
(venv-ansible) [nick@dev simple]$ pre-commit install
pre-commit installed at .git/hooks/pre-commit
(venv-ansible) [nick@dev simple]$ 
(venv-ansible) [nick@dev simple]$ cat .git/hooks/pre-commit
#!/usr/bin/env bash
# File generated by pre-commit: https://pre-commit.com
# ID: 138fd403232d2ddd5efb44317e38bf03

# start templated
INSTALL_PYTHON=/home/nick/venv-ansible/bin/python3
ARGS=(hook-impl --config=.pre-commit-config.yaml --hook-type=pre-commit)
# end templated

HERE="$(cd "$(dirname "$0")" && pwd)"
ARGS+=(--hook-dir "$HERE" -- "$@")

if [ -x "$INSTALL_PYTHON" ]; then
    exec "$INSTALL_PYTHON" -mpre_commit "${ARGS[@]}"
elif command -v pre-commit > /dev/null; then
    exec pre-commit "${ARGS[@]}"
else
    echo '`pre-commit` not found.  Did you forget to activate your virtualenv?' 1>&2
    exit 1
fi
(venv-ansible) [nick@dev simple]$ 
----


== configure 

https://pre-commit.com/#pre-commit-configyaml---top-level

== ansible demo

https://aap2.demoredhat.com/exercises/ansible_config_as_code/0-setup/
step 2


[source,shell]
----
cd /home/nick/ansible/simple
vim .pre-commit-config.yaml
vim .yamllint.yml 
mkdir -p .github/workflows/
vim .github/workflows/pre-commit.yml
vim .gitignore
vim .gitattributes
----

vim .pre-commit-config.yaml

[source,yaml]
----
---
repos:
  - repo: 'https://github.com/pre-commit/pre-commit-hooks'
    rev: v4.3.0
    hooks:
      - id: end-of-file-fixer
      - id: trailing-whitespace
  - repo: 'https://github.com/ansible/ansible-lint.git'
    rev: v6.16.2
    hooks:
      - id: ansible-lint
        pass_filenames: false
        always_run: true
        entry: "ansible-lint"
        args:
          - "--profile=production"
        additional_dependencies:
          - "ansible-core>=2.13"
          - "yamllint>=1.26,<2.0"
...
----

https://yamllint.readthedocs.io/en/stable/

vim .yamllint.yml 

[source,shell]
----
---
extends: default

ignore: |
  changelogs
  vault.yml
rules:
  # 80 chars should be enough, but don't fail if a line is longer
  line-length: disable
  colons:
    max-spaces-before: 0
    max-spaces-after: -1
  document-end:
    present: true
  document-start:
    present: true
  indentation:
    level: error
    # Require indentation https://redhat-cop.github.io/automation-good-practices/#_yaml_and_jinja2_syntax
    spaces: 2
    indent-sequences: true
    check-multi-line-strings: false
  truthy:
    level: error
    # Allow only YAML 1.2 booleans https://redhat-cop.github.io/automation-good-practices/#_yaml_and_jinja2_syntax
    allowed-values:
      - 'true'
      - 'false'
...
----

https://aap2.demoredhat.com/exercises/ansible_config_as_code/0-setup/
step 3

mkdir -p .github/workflows/
vim .github/workflows/pre-commit.yml

[source,shell]
----
---
name: Yaml and Ansible Lint

on: [push, pull_request]  # yamllint disable-line rule:truthy

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
      - name: Install Collections
        run: |
          sudo apt install software-properties-common
          sudo apt-add-repository --yes --update ppa:ansible/ansible
          sudo apt install ansible
      - uses: pre-commit/action@v2.0.0
...
----


step 4

vim .gitignore

[source,shell]
----
.password
ansible.cfg
ansible-navigator.log
*.json
----

vim .gitattributes

[source,shell]
----
*.yml linguist-detectable
*.yaml linguist-detectable
----

step 5


[source,shell]
----
[nick@dev simple]$ source /home/nick/venv-ansible/bin/activate
(venv-ansible) [nick@dev simple]$ 
(venv-ansible) [nick@dev simple]$ source /home/nick/lab-build-proxy.sh 
(venv-ansible) [nick@dev simple]$ 
(venv-ansible) [nick@dev simple]$ 
(venv-ansible) [nick@dev simple]$ git commit -m test
[INFO] Locking pre-commit directory
[INFO] Initializing environment for https://github.com/pre-commit/pre-commit-hooks.
[INFO] Initializing environment for https://github.com/ansible/ansible-lint.git.
[INFO] Initializing environment for https://github.com/ansible/ansible-lint.git:ansible-core>=2.13,yamllint>=1.26,<2.0.
[INFO] Installing environment for https://github.com/pre-commit/pre-commit-hooks.
[INFO] Once installed this environment will be reused.
[INFO] This may take a few minutes...
[INFO] Installing environment for https://github.com/ansible/ansible-lint.git.
[INFO] Once installed this environment will be reused.
[INFO] This may take a few minutes...
fix end of files.........................................................Failed
- hook id: end-of-file-fixer
- exit code: 1
- files were modified by this hook

Fixing .github/workflows/pre-commit.yml
Fixing .gitignore
Fixing .pre-commit-config.yaml
Fixing .yamllint.yml

trim trailing whitespace.................................................Passed
Ansible-lint.............................................................Failed
- hook id: ansible-lint
- exit code: 2

WARNING  Listing 5 violation(s) that are fatal
yaml[trailing-spaces]: Trailing spaces
hello.yml:3

fqcn[action-core]: Use FQCN for builtin module actions (debug).
hello.yml:8 Use `ansible.builtin.debug` or `ansible.legacy.debug` instead.

yaml[indentation]: Wrong indentation: expected 4 but found 2
hello.yml:8

yaml[document-end]: Missing document end "..."
hello.yml:11

yaml[empty-lines]: Too many blank lines (1 > 0)
hello.yml:11

Read documentation for instructions on how to ignore specific rule violations.

                   Rule Violation Summary                    
 count tag                   profile    rule associated tags 
     1 yaml[document-end]    basic      formatting, yaml     
     1 yaml[empty-lines]     basic      formatting, yaml     
     1 yaml[indentation]     basic      formatting, yaml     
     1 yaml[trailing-spaces] basic      formatting, yaml     
     1 fqcn[action-core]     production formatting           

Failed after min profile: 5 failure(s), 0 warning(s) on 2 files.

(venv-ansible) [nick@dev simple]$ 
----


Fix, add, commit, and push 

[source,shell]
----
(venv-ansible) [nick@dev simple]$ vim hello.yml 
(venv-ansible) [nick@dev simple]$ git add . 
(venv-ansible) [nick@dev simple]$ git commit -m test
fix end of files.........................................................Passed
trim trailing whitespace.................................................Passed
Ansible-lint.............................................................Passed
[main 4b26d29] test
 6 files changed, 78 insertions(+), 5 deletions(-)
 create mode 100644 .gitattributes
 create mode 100644 .github/workflows/pre-commit.yml
 create mode 100644 .gitignore
 create mode 100644 .pre-commit-config.yaml
 create mode 100644 .yamllint.yml
(venv-ansible) [nick@dev simple]$ 
(venv-ansible) [nick@dev simple]$ git push
Username for 'https://git.source.example.com': nick
Password for 'https://nick@git.source.example.com': 
Enumerating objects: 12, done.
Counting objects: 100% (12/12), done.
Delta compression using up to 2 threads
Compressing objects: 100% (8/8), done.
Writing objects: 100% (10/10), 1.58 KiB | 1.58 MiB/s, done.
Total 10 (delta 1), reused 0 (delta 0), pack-reused 0
To https://git.source.example.com/ansible/simple.git
   e686ae9..4b26d29  main -> main
(venv-ansible) [nick@dev simple]$ 
----
